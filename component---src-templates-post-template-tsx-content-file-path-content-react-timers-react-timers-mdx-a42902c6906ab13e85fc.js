"use strict";(self.webpackChunkgatsby_blog=self.webpackChunkgatsby_blog||[]).push([[3364],{2796:function(e,n,t){t.r(n),t.d(n,{Head:function(){return i.Ss},default:function(){return m}});var a=t(8876),l=t(4424);function r(e){const n=Object.assign({p:"p",code:"code",h2:"h2",a:"a",span:"span",pre:"pre"},(0,a.MN)(),e.components);return l.createElement(l.Fragment,null,l.createElement(n.p,null,"Не секрет, что такие функции как ",l.createElement(n.code,null,"setInterval"),", ",l.createElement(n.code,null,"setTimeout")," очень хотят быть уничтоженными\nпри размонтировании компонента во избежание утечек памяти. И если с компонентами-классами всё понятно,\nто так ли очевидны способы взаимодействия с таймерами в функциональных компонентах?"),"\n",l.createElement(n.h2,{id:"компонент-класс",style:{position:"relative"}},l.createElement(n.a,{href:"#%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82-%D0%BA%D0%BB%D0%B0%D1%81%D1%81","aria-label":"компонент класс permalink",className:"anchor before"},l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Компонент-класс"),"\n",l.createElement(n.p,null,"В классах заботу о таймерах на себя берёт метод жизненного цикла ",l.createElement(n.code,null,"componentWillUnmount"),".\nОбъявляем таймер и оставляем его на совесть методу."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"import { Component } from 'react';\n\nclass Timer extends Component {\n  timer;\n\n  // таймер срабатывает по клику\n  startTimer = () => {\n    this.timer = setTimeout(() => {\n      console.log('start this.timer');\n    }, 500);\n  }\n\n  componentWillUnmount() {\n    clearTimeout(this.timer); // очистка таймера\n  }\n\n  render() {\n    return <button onClick={this.startTimer}>Start timer</button>;\n  }\n}\n")),"\n",l.createElement(n.h2,{id:"функциональный-компонент",style:{position:"relative"}},l.createElement(n.a,{href:"#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82","aria-label":"функциональный компонент permalink",className:"anchor before"},l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Функциональный компонент"),"\n",l.createElement(n.p,null,"В функциональных компонентах нет возможности задать таймер как константу — это не сработает из-за\nособенностей рендера. Чтобы таймер запускался при каком-то пользовательском действии как в предыдущем примере,\nнужно привязать его через ",l.createElement(n.code,null,"useRef"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"import { useRef, useEffect } from 'react';\n\nexport const Timer = () => {\n  const timerRef = useRef(null);\n\n  // таймер срабатывает по клику\n  const startTimer = () => {\n    timerRef.current = setTimeout(() => {\n      console.log('start current timeout');\n    }, 500);\n  }\n\n  useEffect(() => {\n    return () => clearTimeout(timerRef.current); // очистка таймера\n  }, []);\n\n  return <button onClick={startTimer}>Start timer</button>;\n}\n")),"\n",l.createElement(n.p,null,"Если пользовательских действий не нужно, на помощь придут пользовательские хуки:\nс ними не придётся дублировать код таймера каждый раз."),"\n",l.createElement(n.h2,{id:"хук-usetimeout",style:{position:"relative"}},l.createElement(n.a,{href:"#%D1%85%D1%83%D0%BA-usetimeout","aria-label":"хук usetimeout permalink",className:"anchor before"},l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Хук useTimeout"),"\n",l.createElement(n.p,null,"Аналог таймера, данного выше. Только запускаться он будет сразу после монтирования\nтого компонента, к которому подключен."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"import { useEffect, useRef } from 'react';\n\nexport function useTimeout(callback, delay) {\n  // Запомнить переданную функцию обратного вызова\n  const savedCallback = useRef(callback);\n\n  // переопределять callback при необходимости\n  useEffect(() => {\n    savedCallback.current = callback;\n  }, [callback]);\n\n  // Запустить таймер\n  useEffect(() => {\n    // или не запустить когда не задано время задержки\n    if (delay === null) return;\n\n    const timerId = setTimeout(() => savedCallback.current(), delay);\n    return () => clearTimeout(timerId);\n  }, [delay])\n}\n")),"\n",l.createElement(n.p,null,"Как использовать в компоненте:"),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"// передать в качестве handleCallback функцию,\n// которая должна быть вызвана по таймауту\nuseTimeout(handleCallback, 500);\n")),"\n",l.createElement(n.h2,{id:"хук-useinterval",style:{position:"relative"}},l.createElement(n.a,{href:"#%D1%85%D1%83%D0%BA-useinterval","aria-label":"хук useinterval permalink",className:"anchor before"},l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Хук useInterval"),"\n",l.createElement(n.p,null,"Теперь что-нибудь поинтереснее с интервалом. На многих сайтах есть такой кейс:\nпри вводе логина получать одноразовый пароль по SMS и, если в течение некоторого времени SMS не приходит,\nотправлять запрос заново. Тут и может пригодиться наш хук."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"import { useState, useEffect } from 'react';\n\nexport function useInterval(time, delay) {\n  // запомнить переданное время в секундах\n  const [timeLeft, setTimeLeft] = useState(time);\n\n  useEffect(() => {\n    // не запускать когда не задано время задержки\n  \tif (delay === null) return;\n\n  \t// уменьшать время на единицу\n    const tick = () => {\n      setTimeLeft(timeLeft - 1);\n    };\n\n    // старт\n    const timerId = setInterval(tick, delay);\n\n    // остановить если время истекло\n    if (timeLeft <= 0) clearInterval(id);\n\n    // очистить интервал\n    return () => clearInterval(timerId);\n  }, [delay, timeLeft]);\n\n  // передать управление интервалом вовне\n  return [timeLeft, setTimeLeft];\n}\n")),"\n",l.createElement(n.p,null,"Как использовать в компоненте:"),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-jsx"},"// импорт хука\nimport { useInterval } from '../hooks/useInterval';\n\nconst ONE_SECOND = 1000;\nconst ONE_MINUTE = 60;\n\nconst formatTime = time => time > 9 ? time : `0${time}`;\n\nexport const Timeout = () => {\n  // получить данные из хука\n  // задать время 2 мнуты, остаток менять с интервалом в секунду\n  const [timeLeft, setTimeLeft] = useInterval(ONE_MINUTE * 2, ONE_SECOND);\n\n  // используем timeLeft для привычного отображения времени\n  const minutes = formatTime(Math.floor(timeLeft / ONE_MINUTE));\n  const seconds = formatTime(timeLeft - minutes * ONE_MINUTE);\n\n  const handleStartTimer = () => {\n    setTimeLeft(ONE_MINUTE);\n  };\n\n  return (\n    <div>\n      {\n        timeLeft > 0\n        ? <p>До повторной отправки осталось: {minutes}:{seconds}</p>\n        : <button onClick={handleStartTimer}>Отправить SMS</button>\n      }\n    </div>\n  )\n};\n")),"\n",l.createElement(n.p,null,"Пока время не истекло, будет выводиться счётчик с таймером. После — кнопка с возможностью\nсбросить счётчик и запустить любую другую функцию."))}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,a.MN)(),e.components);return n?l.createElement(n,e,l.createElement(r,e)):r(e)},i=t(7792),s=t(7619);function o(e){var n,t;let{data:{mdx:a},children:r,pageContext:{prev:c,next:o}}=e;const{h1:m,title:u,description:f,image:d,table_of_contents:h}=a.frontmatter;return(0,l.useEffect)((()=>{(0,s.K)()}),[]),l.createElement(l.Fragment,null,l.createElement(i._W,{h1:m,title:u,description:f,image:null===(n=a.frontmatter.image)||void 0===n?void 0:n.publicURL},l.createElement(i.MV,{post:a.frontmatter,imageData:null==d||null===(t=d.childImageSharp)||void 0===t?void 0:t.gatsbyImageData},h?l.createElement(i.G8,{headings:a.tableOfContents}):null,l.createElement("div",{className:"page__content"},r,l.createElement(i.Mf,{prev:c,next:o})),l.createElement(i.QZ,null))))}function m(e){return l.createElement(o,e,l.createElement(c,e))}},8876:function(e,n,t){t.d(n,{MN:function(){return r}});var a=t(4424);const l=a.createContext({});function r(e){const n=a.useContext(l);return a.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);