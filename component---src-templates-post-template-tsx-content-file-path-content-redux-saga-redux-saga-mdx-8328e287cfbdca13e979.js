"use strict";(self.webpackChunkgatsby_blog=self.webpackChunkgatsby_blog||[]).push([[7584],{4804:function(e,n,t){t.r(n),t.d(n,{Head:function(){return s.Ss},default:function(){return m}});var r=t(8876),a=t(4424),l=t(8860);function o(e){const n=Object.assign({p:"p",code:"code",pre:"pre",h2:"h2",a:"a",span:"span",h3:"h3",ul:"ul",li:"li"},(0,r.MN)(),e.components);return a.createElement(a.Fragment,null,a.createElement(n.p,null,"У разработчиков двойственные впечатления о redux-saga. Кто-то любит саги, кто-то считает\nих бесполезными. Автор придерживается мнения, что саги удобны: они позволяют\nотделить логику взаимодействия с REST API, задать последовательность событий\nи реагировать на них."),"\n",a.createElement(n.p,null,"Предлагаю пробежаться по настройке саг в связке с ",a.createElement(n.code,null,"redux-toolkit"),",\nпонять в какой момент они начинают работать и решить для себя нужны они вам\nили нет. Для любопытных ссылки на первоисточники в конце поста."),"\n",a.createElement(l.y,{heading:"Примечание"},a.createElement(n.p,null,"Заметка будет полезна тем, кто уже знаком с основными понятиями redux.\nЕсли читатель никогда не пользовался этим менеджером состояния, многое\nможет казаться странным из-за специфической терминологии.")),"\n",a.createElement(n.p,null,"Дабы не разводить кашу из switch-инструкций оригинального ",a.createElement(n.code,null,"redux"),", воспользуемся\nвспомогательным средством в виде ",a.createElement(n.code,null,"redux-toolkit"),". Для быстрого старта\nкак всегда берём ",a.createElement(n.code,null,"react-create-app"),"."),"\n",a.createElement(n.p,null,"Установка зависимостей:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-shell"},"$ npx create-react-app saga_app\n$ cd saga_app\n$ npm i axios redux react-redux @reduxjs/toolkit redux-saga redux-saga-routines\n")),"\n",a.createElement(n.h2,{id:"redux-toolkit",style:{position:"relative"}},a.createElement(n.a,{href:"#redux-toolkit","aria-label":"redux toolkit permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Redux Toolkit"),"\n",a.createElement(n.p,null,"В этом разделе приведён небольшой пример работы с ",a.createElement(n.code,null,"redux-toolkit"),". Обычный\nсчётчик, значение которого можно уменьшать или увеличивать. Если читатель\nзахочет проверить нижеизложенное на практике, упомянутые файлы\nнужно создать самостоятельно."),"\n",a.createElement(n.p,null,"Нам понадобятся  стандартные ",a.createElement(n.code,null,"actions")," и ",a.createElement(n.code,null,"reducer"),". Когда вызывается ",a.createElement(n.code,null,"action"),",\nна событие реагирует ",a.createElement(n.code,null,"reducer")," — чистая функция, возвращающая новое состояние."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/store/counter.js\nimport { createAction, createReducer } from '@reduxjs/toolkit'\n\n// action creators\nexport const increment = createAction('counter/INCREMENT')\nexport const decrement = createAction('counter/DECREMENT')\n\n// reducer принимает начальное состояние 0\nconst counter = createReducer(0, {\n  [increment.type]: state => state + 1,\n  [decrement.type]: state => state - 1\n})\n\nexport default counter\n")),"\n",a.createElement(n.p,null,"В главном файле хранилища подключаются редьюсеры и конфигурируется\nсамо хранилище."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/store/index.js\nimport { combineReducers } from 'redux'\nimport { configureStore } from '@reduxjs/toolkit'\nimport counter from './counter'\n\n// можно передать несколько разных редьюсеров, у нас он пока один\nconst rootReducer = combineReducers({ counter })\n\nexport default configureStore({\n  reducer: rootReducer,\n})\n")),"\n",a.createElement(n.p,null,"Осталось подключить ",a.createElement(n.code,null,"Provider")," и передать ему ",a.createElement(n.code,null,"store"),"."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-jsx"},"// src/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport { Provider } from 'react-redux'\n\nimport store from './store'\nimport App from './app'\n\nReactDOM.render(\n  <React.StrictMode>\n    <Provider store={store}>\n      <App />\n    </Provider>\n  </React.StrictMode>,\n  document.getElementById('root')\n)\n")),"\n",a.createElement(n.p,null,"Переходим к входной точке приложения. Здесь выводим начальное\nзначение счётчика и управляем им при помощи хука ",a.createElement(n.code,null,"useDispatch"),"."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-jsx"},"// src/app.js\nimport { useDispatch, useSelector } from 'react-redux'\nimport { increment, decrement } from './store/counter'\n\nfunction App() {\n  const dispatch = useDispatch()\n  // получить значение счётчика\n  const counter = useSelector(state => state.counter)\n\n  // вызывать действие (action) при нажатии на кнопку\n  const handleCounterIncrement = () => dispatch(increment())\n  const handleCounterDecrement = () => dispatch(decrement())\n\n  return (\n    <div>\n      <p>{counter}</p>\n      <button type=\"button\" onClick={handleCounterIncrement}>+ counter</button>\n      <button type=\"button\" onClick={handleCounterDecrement}>- counter</button>\n    </div>\n  );\n}\n\nexport default App\n")),"\n",a.createElement(n.h2,{id:"redux-saga",style:{position:"relative"}},a.createElement(n.a,{href:"#redux-saga","aria-label":"redux saga permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Redux Saga"),"\n",a.createElement(n.p,null,"Пример: есть авторизация. Отправляем логин и пароль, в ответ получаем токен.\nС этим токеном на руках идём за данными пользователя. Приступим."),"\n",a.createElement(n.h3,{id:"api",style:{position:"relative"}},a.createElement(n.a,{href:"#api","aria-label":"api permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"API"),"\n",a.createElement(n.p,null,"Подойдёт любой доступный на просторах интернета открытый API. Ну и что-нибудь, что будет\nк этому API обращаться, будь то ",a.createElement(n.code,null,"axios")," или ",a.createElement(n.code,null,"fetch"),", не столь важно."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/api/instance.js\nimport axios from 'axios'\n\n// экземпляр axios\nexport const apiInstance = (params = {}) => {\n  const { token } = params\n  const config = {\n    baseURL: 'https://reqres.in/api',\n    headers: { 'Content-Type': 'application/json' },\n    timeout: 1000,\n  };\n\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`\n  }\n\n  return axios.create(config)\n}\n")),"\n",a.createElement(n.p,null,"Описание методов API для работы с данными пользователя."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/api/user.js\nimport { apiInstance } from './instance'\n\nexport const User = {\n  login: function (params = {}) {\n    const { email, password } = params\n    const api = apiInstance()\n\n    return api.post('/login', { email, password })\n  },\n\n  getInfo: function (params = {}) {\n    const { token } = params\n    const api = apiInstance({ token })\n\n    return api.get('/users/1')\n  }\n}\n")),"\n",a.createElement(n.h3,{id:"хранилище",style:{position:"relative"}},a.createElement(n.a,{href:"#%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D0%BB%D0%B8%D1%89%D0%B5","aria-label":"хранилище permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Хранилище"),"\n",a.createElement(n.p,null,"Чтобы было удобнее обращаться с сагами, создаём роутины. Из них можно\nизвлечь action creators: ",a.createElement(n.code,null,"success"),", ",a.createElement(n.code,null,"fulfill"),", ",a.createElement(n.code,null,"failure")," и использовать чтобы\nотдать данные дальше редьюсеру или же обработать ошибку."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/store/user.js\nimport { createReducer } from '@reduxjs/toolkit'\nimport { createRoutine } from 'redux-saga-routines'\n\n// state\nconst initialState = {\n  token: '',\n  info: {},\n}\n\n// routine теперь заменяет action creator\nexport const login = createRoutine('user/LOG_IN')\n\n// reducer откликается на созданные роутинами actions\nconst user = createReducer(initialState, {\n  [login.SUCCESS]: (state, action) => {\n    const { token, info } = action.payload\n    return { ...state, token, info }\n  }\n})\n\nexport default user\n")),"\n",a.createElement(n.h3,{id:"саги",style:{position:"relative"}},a.createElement(n.a,{href:"#%D1%81%D0%B0%D0%B3%D0%B8","aria-label":"саги permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Саги"),"\n",a.createElement(n.p,null,"Саги спокойно делятся на файлы и подключаются (подобно редьюсерам в ",a.createElement(n.code,null,"rootReducer"),") в одной ",a.createElement(n.code,null,"rootSaga"),".\nСаги — функции-генераторы. Их принято разделять на ",a.createElement(n.code,null,"worker")," и ",a.createElement(n.code,null,"watcher"),".\nWorker содержит логику. Watcher следит за экшенами."),"\n",a.createElement(n.p,null,"Проще говоря, дело обстоит так: вы вызываете действие, а сага слушает когда\nкакое-то действие будет вызвано и перехватывает его. Берёт работу на себя.\nОбращается к серверу, получает данные, при необходимости делает какие-то преобразования.\nПосле выполнения своей нелёгкой работы отдаёт результат редьюсеру. А дело редьюсера —\nуправлять хранилищем и только."),"\n",a.createElement(n.p,null,"Поэтому саги — это ",a.createElement(n.code,null,"middleware"),", промежуточный слой между ",a.createElement(n.code,null,"action")," и ",a.createElement(n.code,null,"reducer"),"."),"\n",a.createElement(n.p,null,"Обратимся к примеру."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/sagas/userSaga.js\nimport { call, put, takeLatest } from 'redux-saga/effects'\nimport { User } from '../api/user'\nimport { login } from '../store/user'\n\n// worker\nfunction* loginWorker(action) {\n  // принимает email и password извне\n  const { email, password } = action.payload;\n  const { success, fulfill } = login;\n\n  try {\n    // запросить токен, получить его, а затем попытаться запросить данные\n    const { data: authData } = yield call(User.login, { email, password })\n    const { token } = authData\n    const { data } = yield call(User.getInfo, { token })\n\n    // в случае успеха отдать данные редьюсеру\n    yield put(success({ token, info: data.data }))\n  } catch (error) {\n    // ошибку можно тоже отдать редьюсеру через вызов failure\n    // или получить в компоненте\n    // или вообще написать функцию-обработчик, правящую миром ошибок\n    console.error(error)\n  } finally {\n    yield put(fulfill())\n  }\n}\n\n// watcher\n// при срабатывании триггера login отработает и loginWorker\nexport function* userWatcher() {\n  yield takeLatest(login.TRIGGER, loginWorker)\n}\n")),"\n",a.createElement(n.p,null,"Корневая сага принимает все саги и запускает их, чтобы они начали\nпрослушивать экшены."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/sagas/rootSaga.js\nimport { all } from 'redux-saga/effects'\nimport { userWatcher } from './userSaga'\n\nexport default function* rootSaga() {\n  yield all([\n    userWatcher(),\n  ])\n}\n")),"\n",a.createElement(n.p,null,"Хранилище, конечно, тоже придётся перенастроить."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-js"},"// src/store/index.js\nimport { combineReducers } from 'redux'\nimport createSagaMiddleware from 'redux-saga'\nimport { configureStore, getDefaultMiddleware } from '@reduxjs/toolkit'\n\nimport counter from './counter'\nimport user from './user'\nimport rootSaga from '../sagas/rootSaga'\n\n// добавить sagaMiddleware\nconst sagaMiddleware = createSagaMiddleware()\nconst middleware = [...getDefaultMiddleware({ thunk: false }), sagaMiddleware];\n\n// добавить user reducer\nconst rootReducer = combineReducers({\n  counter,\n  user,\n})\n\n// использовать middleware\nconst store = configureStore({\n  reducer: rootReducer,\n  middleware,\n})\n\n// и запустить корневую сагу\nsagaMiddleware.run(rootSaga)\n\nexport default store\n")),"\n",a.createElement(n.h3,{id:"вызов-action-в-компоненте",style:{position:"relative"}},a.createElement(n.a,{href:"#%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2-action-%D0%B2-%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82%D0%B5","aria-label":"вызов action в компоненте permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Вызов action в компоненте"),"\n",a.createElement(n.p,null,"В компоненте мало что меняется. Ну, разве что теперь в ",a.createElement(n.code,null,"dispatch"),"\nпередаются внешние данные в виде логина и пароля пользователя."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-jsx"},'// src/app.js\nimport { useDispatch } from \'react-redux\'\nimport { login } from \'./store/user\'\n\nconst userData = {\n  "email": "eve.holt@reqres.in",\n  "password": "cityslicka"\n}\n\nfunction App() {\n  const dispatch = useDispatch();\n  const logIn = () => dispatch(login(userData))\n\n  return <button type="button" onClick={logIn}>log in</button>\n}\n\nexport default App\n')),"\n",a.createElement(n.h2,{id:"источники",style:{position:"relative"}},a.createElement(n.a,{href:"#%D0%B8%D1%81%D1%82%D0%BE%D1%87%D0%BD%D0%B8%D0%BA%D0%B8","aria-label":"источники permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Источники"),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,a.createElement(n.a,{href:"https://iamakulov.com/talks/redux-in-real-life/",target:"_blank",rel:"nofollow"},"redux в реальной жизни")),"\n",a.createElement(n.li,null,a.createElement(n.a,{href:"https://redux-toolkit.js.org/",target:"_blank",rel:"nofollow"},"redux-toolkit")),"\n",a.createElement(n.li,null,a.createElement(n.a,{href:"https://redux-saga.js.org/",target:"_blank",rel:"nofollow"},"redux-saga")),"\n",a.createElement(n.li,null,a.createElement(n.a,{href:"https://github.com/afitiskin/redux-saga-routines",target:"_blank",rel:"nofollow"},"redux-saga-routines")),"\n"))}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,r.MN)(),e.components);return n?a.createElement(n,e,a.createElement(o,e)):o(e)},s=t(7792),i=t(7619);function u(e){var n,t;let{data:{mdx:r},children:l,pageContext:{prev:o,next:c}}=e;const{h1:u,title:m,description:d,image:p,table_of_contents:h}=r.frontmatter;return(0,a.useEffect)((()=>{(0,i.K)()}),[]),a.createElement(a.Fragment,null,a.createElement(s._W,{h1:u,title:m,description:d,image:null===(n=r.frontmatter.image)||void 0===n?void 0:n.publicURL},a.createElement(s.MV,{post:r.frontmatter,imageData:null==p||null===(t=p.childImageSharp)||void 0===t?void 0:t.gatsbyImageData},h?a.createElement(s.G8,{headings:r.tableOfContents}):null,a.createElement("div",{className:"page__content"},l,a.createElement(s.Mf,{prev:o,next:c})),a.createElement(s.QZ,null))))}function m(e){return a.createElement(u,e,a.createElement(c,e))}},8860:function(e,n,t){t.d(n,{y:function(){return r.y}});var r=t(3836)},8876:function(e,n,t){t.d(n,{MN:function(){return l}});var r=t(4424);const a=r.createContext({});function l(e){const n=r.useContext(a);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);